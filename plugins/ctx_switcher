#!/usr/bin/env bash

. "$(dirname "$0")"/.nnn-plugin-helper

# Plugin for nnn to list and switch between contexts
# Shows context number and path for selection

# Exit if NNN_PIPE is not set
if [ -z "$NNN_PIPE" ]; then
    echo "Error: NNN_PIPE is not set. This plugin must be run from within nnn."
    exit 1
fi

# Check if we have all 8 context paths
if [ -z "$d1" ] && [ -z "$d2" ] && [ -z "$d3" ] && [ -z "$d4" ] && [ -z "$d5" ] && [ -z "$d6" ] && [ -z "$d7" ] && [ -z "$d8" ]; then
    echo "No contexts available."
    read -r _
    exit 1
fi

# Temporary file for selection
TMPFILE="$(mktemp)"
trap 'rm -f "$TMPFILE"' EXIT

# Current context (the one we are in)
# CURCTX="$((NNN_LEVEL + 1))"

# Build the selection menu
{
    for i in {1..8}; do
        eval path="\$d$i"
        if [ -n "$path" ]; then
            # Add a marker for current context
            if [ "$path" == "$2" ]; then
                echo "$i: $path [current]"
            else
                echo "$i: $path"
            fi
        fi
    done
} > "$TMPFILE"

# Count number of lines in the file
LINES=$(wc -l < "$TMPFILE")

if [ "$LINES" -eq 0 ]; then
    echo "No contexts available."
    read -r _
    exit 1
fi

# Use fzf to select a context if available, otherwise use a simpler approach
if command -v fzf >/dev/null 2>&1; then
    # Use fzf for selection with nice formatting
    SELECTED=$(fzf --height=50% --layout=reverse --border \
               --prompt="Select a context to switch to: " \
               --header="Available contexts (total: $LINES)" < "$TMPFILE")
else
    # Simple selection without fzf
    echo "Available contexts (total: $LINES):"
    cat "$TMPFILE"
    echo ""
    echo -n "Select a context to switch to [1-8]: "
    read -r input
    
    # Find the corresponding line
    SELECTED=$(grep "^$input: " "$TMPFILE")
fi

# Exit if nothing was selected
if [ -z "$SELECTED" ]; then
    exit 0
fi

# Extract the context number
CTX_NUM=$(echo "$SELECTED" | cut -d':' -f1)
CTX_DIR=$(echo "$SELECTED" | cut -d':' -f2)

tmux send-keys -t : . "$CTX_NUM"

exit 0
